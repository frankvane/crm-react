{
    "sourceFile": "src/pages/permission/users/components/AssignRoles.tsx",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 17,
            "patches": [
                {
                    "date": 1746144125568,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                },
                {
                    "date": 1746144135556,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -85,5 +85,5 @@\n     </Modal>\r\n   );\r\n };\r\n \r\n-export default AssignRoles;\n\\ No newline at end of file\n+export default AssignRoles;\r\n"
                },
                {
                    "date": 1746144699410,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,8 +25,9 @@\n   const { data: roles } = useQuery<IRole[]>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n+      console.log(response);\r\n       return response.data;\r\n     },\r\n   });\r\n \r\n"
                },
                {
                    "date": 1746144765191,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,9 +26,9 @@\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n       console.log(response);\r\n-      return response.data;\r\n+      return response;\r\n     },\r\n   });\r\n \r\n   // 分配角色\r\n"
                },
                {
                    "date": 1746144779387,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,9 +25,8 @@\n   const { data: roles } = useQuery<IRole[]>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n-      console.log(response);\r\n       return response;\r\n     },\r\n   });\r\n \r\n"
                },
                {
                    "date": 1746144794071,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -25,9 +25,9 @@\n   const { data: roles } = useQuery<IRole[]>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n-      return response;\r\n+      return response.data;\r\n     },\r\n   });\r\n \r\n   // 分配角色\r\n"
                },
                {
                    "date": 1746144837306,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,8 @@\n import { Form, Modal, Select, message } from \"antd\";\r\n import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\r\n \r\n+import type { IResponse } from \"@/types/api/common\";\r\n import type { IRole } from \"@/types/api/role\";\r\n import { assignRoles } from \"@/api/modules/user\";\r\n import { getAllRoles } from \"@/api/modules/role\";\r\n \r\n@@ -21,13 +22,16 @@\n   const [form] = Form.useForm();\r\n   const queryClient = useQueryClient();\r\n \r\n   // 获取所有角色\r\n-  const { data: roles } = useQuery<IRole[]>({\r\n+  const { data: roles } = useQuery<IResponse<IRole[]>>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n-      return response.data;\r\n+      if (!response.data) {\r\n+        throw new Error(\"Failed to fetch roles data\");\r\n+      }\r\n+      return response;\r\n     },\r\n   });\r\n \r\n   // 分配角色\r\n@@ -73,9 +77,9 @@\n             mode=\"multiple\"\r\n             placeholder=\"请选择角色\"\r\n             allowClear\r\n             style={{ width: \"100%\" }}\r\n-            options={roles?.map((role) => ({\r\n+            options={roles?.data?.map((role) => ({\r\n               label: role.name,\r\n               value: role.id,\r\n               disabled: role.status === 0, // 禁用状态为0的角色\r\n             }))}\r\n"
                },
                {
                    "date": 1746144863291,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -22,19 +22,15 @@\n   const [form] = Form.useForm();\r\n   const queryClient = useQueryClient();\r\n \r\n   // 获取所有角色\r\n-  const { data: roles } = useQuery<IResponse<IRole[]>>({\r\n+  const { data: rolesResponse } = useQuery<IResponse<IRole[]>>({\r\n     queryKey: [\"allRoles\"],\r\n-    queryFn: async () => {\r\n-      const response = await getAllRoles();\r\n-      if (!response.data) {\r\n-        throw new Error(\"Failed to fetch roles data\");\r\n-      }\r\n-      return response;\r\n-    },\r\n+    queryFn: getAllRoles,\r\n   });\r\n \r\n+  const roles = rolesResponse?.data || [];\r\n+\r\n   // 分配角色\r\n   const assignRolesMutation = useMutation({\r\n     mutationFn: (values: { roleIds: number[] }) =>\r\n       assignRoles(userId as number, values),\r\n@@ -77,9 +73,9 @@\n             mode=\"multiple\"\r\n             placeholder=\"请选择角色\"\r\n             allowClear\r\n             style={{ width: \"100%\" }}\r\n-            options={roles?.data?.map((role) => ({\r\n+            options={roles.map((role: IRole) => ({\r\n               label: role.name,\r\n               value: role.id,\r\n               disabled: role.status === 0, // 禁用状态为0的角色\r\n             }))}\r\n"
                },
                {
                    "date": 1746144874736,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -24,9 +24,12 @@\n \r\n   // 获取所有角色\r\n   const { data: rolesResponse } = useQuery<IResponse<IRole[]>>({\r\n     queryKey: [\"allRoles\"],\r\n-    queryFn: getAllRoles,\r\n+    queryFn: async () => {\r\n+      const response = await getAllRoles();\r\n+      return response;\r\n+    },\r\n   });\r\n \r\n   const roles = rolesResponse?.data || [];\r\n \r\n"
                },
                {
                    "date": 1746146220541,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,7 @@\n import { Form, Modal, Select, message } from \"antd\";\r\n import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\r\n \r\n-import type { IResponse } from \"@/types/api/common\";\r\n import type { IRole } from \"@/types/api/role\";\r\n import { assignRoles } from \"@/api/modules/user\";\r\n import { getAllRoles } from \"@/api/modules/role\";\r\n \r\n@@ -22,18 +21,19 @@\n   const [form] = Form.useForm();\r\n   const queryClient = useQueryClient();\r\n \r\n   // 获取所有角色\r\n-  const { data: rolesResponse } = useQuery<IResponse<IRole[]>>({\r\n+  const { data: roles = [] } = useQuery<IRole[]>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n+      if (!response) {\r\n+        throw new Error(\"Failed to fetch roles\");\r\n+      }\r\n       return response;\r\n     },\r\n   });\r\n \r\n-  const roles = rolesResponse?.data || [];\r\n-\r\n   // 分配角色\r\n   const assignRolesMutation = useMutation({\r\n     mutationFn: (values: { roleIds: number[] }) =>\r\n       assignRoles(userId as number, values),\r\n@@ -52,8 +52,11 @@\n       console.error(\"验证失败:\", error);\r\n     }\r\n   };\r\n \r\n+  // 将当前角色ID转换为对应的角色对象\r\n+  const defaultRoles = roles.filter((role) => currentRoles.includes(role.id));\r\n+\r\n   return (\r\n     <Modal\r\n       title=\"分配角色\"\r\n       open={visible}\r\n@@ -63,9 +66,9 @@\n       destroyOnClose\r\n     >\r\n       <Form\r\n         form={form}\r\n-        initialValues={{ roleIds: currentRoles }}\r\n+        initialValues={{ roleIds: defaultRoles.map((role) => role.id) }}\r\n         preserve={false}\r\n       >\r\n         <Form.Item\r\n           name=\"roleIds\"\r\n@@ -76,13 +79,14 @@\n             mode=\"multiple\"\r\n             placeholder=\"请选择角色\"\r\n             allowClear\r\n             style={{ width: \"100%\" }}\r\n-            options={roles.map((role: IRole) => ({\r\n+            options={roles.map((role) => ({\r\n               label: role.name,\r\n               value: role.id,\r\n               disabled: role.status === 0, // 禁用状态为0的角色\r\n             }))}\r\n+            optionFilterProp=\"label\"\r\n           />\r\n         </Form.Item>\r\n       </Form>\r\n     </Modal>\r\n"
                },
                {
                    "date": 1746146245521,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,7 +1,8 @@\n import { Form, Modal, Select, message } from \"antd\";\r\n import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\r\n \r\n+import type { IResponse } from \"@/types/api/common\";\r\n import type { IRole } from \"@/types/api/role\";\r\n import { assignRoles } from \"@/api/modules/user\";\r\n import { getAllRoles } from \"@/api/modules/role\";\r\n \r\n@@ -21,9 +22,9 @@\n   const [form] = Form.useForm();\r\n   const queryClient = useQueryClient();\r\n \r\n   // 获取所有角色\r\n-  const { data: roles = [] } = useQuery<IRole[]>({\r\n+  const { data: rolesResponse } = useQuery<IResponse<IRole[]>>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n       if (!response) {\r\n@@ -32,8 +33,10 @@\n       return response;\r\n     },\r\n   });\r\n \r\n+  const roles = rolesResponse?.data || [];\r\n+\r\n   // 分配角色\r\n   const assignRolesMutation = useMutation({\r\n     mutationFn: (values: { roleIds: number[] }) =>\r\n       assignRoles(userId as number, values),\r\n@@ -53,9 +56,11 @@\n     }\r\n   };\r\n \r\n   // 将当前角色ID转换为对应的角色对象\r\n-  const defaultRoles = roles.filter((role) => currentRoles.includes(role.id));\r\n+  const defaultRoles = roles.filter((role: IRole) =>\r\n+    currentRoles.includes(role.id)\r\n+  );\r\n \r\n   return (\r\n     <Modal\r\n       title=\"分配角色\"\r\n@@ -66,9 +71,9 @@\n       destroyOnClose\r\n     >\r\n       <Form\r\n         form={form}\r\n-        initialValues={{ roleIds: defaultRoles.map((role) => role.id) }}\r\n+        initialValues={{ roleIds: defaultRoles.map((role: IRole) => role.id) }}\r\n         preserve={false}\r\n       >\r\n         <Form.Item\r\n           name=\"roleIds\"\r\n@@ -79,9 +84,9 @@\n             mode=\"multiple\"\r\n             placeholder=\"请选择角色\"\r\n             allowClear\r\n             style={{ width: \"100%\" }}\r\n-            options={roles.map((role) => ({\r\n+            options={roles.map((role: IRole) => ({\r\n               label: role.name,\r\n               value: role.id,\r\n               disabled: role.status === 0, // 禁用状态为0的角色\r\n             }))}\r\n"
                },
                {
                    "date": 1746146342409,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,8 +26,9 @@\n   const { data: rolesResponse } = useQuery<IResponse<IRole[]>>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n+      console.log(response);\r\n       if (!response) {\r\n         throw new Error(\"Failed to fetch roles\");\r\n       }\r\n       return response;\r\n"
                },
                {
                    "date": 1746146379633,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -26,9 +26,8 @@\n   const { data: rolesResponse } = useQuery<IResponse<IRole[]>>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n-      console.log(response);\r\n       if (!response) {\r\n         throw new Error(\"Failed to fetch roles\");\r\n       }\r\n       return response;\r\n"
                },
                {
                    "date": 1746146495772,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,9 +33,9 @@\n       return response;\r\n     },\r\n   });\r\n \r\n-  const roles = rolesResponse?.data || [];\r\n+  const roles = rolesResponse || [];\r\n \r\n   // 分配角色\r\n   const assignRolesMutation = useMutation({\r\n     mutationFn: (values: { roleIds: number[] }) =>\r\n"
                },
                {
                    "date": 1746147165194,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,9 +33,9 @@\n       return response;\r\n     },\r\n   });\r\n \r\n-  const roles = rolesResponse || [];\r\n+  const roles = rolesResponse?.data || [];\r\n \r\n   // 分配角色\r\n   const assignRolesMutation = useMutation({\r\n     mutationFn: (values: { roleIds: number[] }) =>\r\n"
                },
                {
                    "date": 1746147192361,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -33,9 +33,9 @@\n       return response;\r\n     },\r\n   });\r\n \r\n-  const roles = rolesResponse?.data || [];\r\n+  const roles = rolesResponse || [];\r\n \r\n   // 分配角色\r\n   const assignRolesMutation = useMutation({\r\n     mutationFn: (values: { roleIds: number[] }) =>\r\n"
                },
                {
                    "date": 1746147242247,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -1,8 +1,7 @@\n import { Form, Modal, Select, message } from \"antd\";\r\n import { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\r\n \r\n-import type { IResponse } from \"@/types/api/common\";\r\n import type { IRole } from \"@/types/api/role\";\r\n import { assignRoles } from \"@/api/modules/user\";\r\n import { getAllRoles } from \"@/api/modules/role\";\r\n \r\n@@ -22,9 +21,9 @@\n   const [form] = Form.useForm();\r\n   const queryClient = useQueryClient();\r\n \r\n   // 获取所有角色\r\n-  const { data: rolesResponse } = useQuery<IResponse<IRole[]>>({\r\n+  const { data: roles = [] } = useQuery<IRole[]>({\r\n     queryKey: [\"allRoles\"],\r\n     queryFn: async () => {\r\n       const response = await getAllRoles();\r\n       if (!response) {\r\n@@ -33,10 +32,8 @@\n       return response;\r\n     },\r\n   });\r\n \r\n-  const roles = rolesResponse || [];\r\n-\r\n   // 分配角色\r\n   const assignRolesMutation = useMutation({\r\n     mutationFn: (values: { roleIds: number[] }) =>\r\n       assignRoles(userId as number, values),\r\n"
                },
                {
                    "date": 1746147277735,
                    "content": "Index: \n===================================================================\n--- \n+++ \n@@ -23,15 +23,9 @@\n \r\n   // 获取所有角色\r\n   const { data: roles = [] } = useQuery<IRole[]>({\r\n     queryKey: [\"allRoles\"],\r\n-    queryFn: async () => {\r\n-      const response = await getAllRoles();\r\n-      if (!response) {\r\n-        throw new Error(\"Failed to fetch roles\");\r\n-      }\r\n-      return response;\r\n-    },\r\n+    queryFn: getAllRoles,\r\n   });\r\n \r\n   // 分配角色\r\n   const assignRolesMutation = useMutation({\r\n"
                }
            ],
            "date": 1746144125568,
            "name": "Commit-0",
            "content": "import { Form, Modal, Select, message } from \"antd\";\r\nimport { useMutation, useQuery, useQueryClient } from \"@tanstack/react-query\";\r\n\r\nimport type { IRole } from \"@/types/api/role\";\r\nimport { assignRoles } from \"@/api/modules/user\";\r\nimport { getAllRoles } from \"@/api/modules/role\";\r\n\r\ninterface AssignRolesProps {\r\n  visible: boolean;\r\n  userId?: number;\r\n  currentRoles?: number[];\r\n  onCancel: () => void;\r\n}\r\n\r\nconst AssignRoles = ({\r\n  visible,\r\n  userId,\r\n  currentRoles = [],\r\n  onCancel,\r\n}: AssignRolesProps) => {\r\n  const [form] = Form.useForm();\r\n  const queryClient = useQueryClient();\r\n\r\n  // 获取所有角色\r\n  const { data: roles } = useQuery<IRole[]>({\r\n    queryKey: [\"allRoles\"],\r\n    queryFn: async () => {\r\n      const response = await getAllRoles();\r\n      return response.data;\r\n    },\r\n  });\r\n\r\n  // 分配角色\r\n  const assignRolesMutation = useMutation({\r\n    mutationFn: (values: { roleIds: number[] }) =>\r\n      assignRoles(userId as number, values),\r\n    onSuccess: () => {\r\n      message.success(\"角色分配成功\");\r\n      queryClient.invalidateQueries({ queryKey: [\"users\"] });\r\n      onCancel();\r\n    },\r\n  });\r\n\r\n  const handleOk = async () => {\r\n    try {\r\n      const values = await form.validateFields();\r\n      assignRolesMutation.mutate(values);\r\n    } catch (error) {\r\n      console.error(\"验证失败:\", error);\r\n    }\r\n  };\r\n\r\n  return (\r\n    <Modal\r\n      title=\"分配角色\"\r\n      open={visible}\r\n      onOk={handleOk}\r\n      onCancel={onCancel}\r\n      confirmLoading={assignRolesMutation.isPending}\r\n      destroyOnClose\r\n    >\r\n      <Form\r\n        form={form}\r\n        initialValues={{ roleIds: currentRoles }}\r\n        preserve={false}\r\n      >\r\n        <Form.Item\r\n          name=\"roleIds\"\r\n          label=\"角色\"\r\n          rules={[{ required: true, message: \"请选择角色\" }]}\r\n        >\r\n          <Select\r\n            mode=\"multiple\"\r\n            placeholder=\"请选择角色\"\r\n            allowClear\r\n            style={{ width: \"100%\" }}\r\n            options={roles?.map((role) => ({\r\n              label: role.name,\r\n              value: role.id,\r\n              disabled: role.status === 0, // 禁用状态为0的角色\r\n            }))}\r\n          />\r\n        </Form.Item>\r\n      </Form>\r\n    </Modal>\r\n  );\r\n};\r\n\r\nexport default AssignRoles;"
        }
    ]
}